## 安装docker

部署网络

```
docker network create doj
```

## MySQL

```bash
mkdir -p mysql/{data,conf,init}

docker run -d \
  --name mysql \
  -p 3306:3306 \
  -e TZ=Asia/Shanghai \
  -e MYSQL_ROOT_PASSWORD=123 \
  -v mysql/data:/var/lib/mysql \
  -v mysql/conf:/etc/mysql/conf.d \
  -v mysql/init:/docker-entrypoint-initdb.d \
  --network doj\
  mysql
```

## nacos

首先得在上面创建的mysql数据库中新建一个nacos表

```sql
create database nacos;
```

然后初始化一下待会要使用的表（参考`SQL/nacos.sql`）。

接着再配置一下nacos的一些参数文件

```bash
mkdir nacos/custom.env

PREFER_HOST_MODE=hostname
MODE=standalone
SPRING_DATASOURCE_PLATFORM=mysql
MYSQL_SERVICE_HOST=172.18.0.2
MYSQL_SERVICE_DB_NAME=nacos
MYSQL_SERVICE_PORT=3306
MYSQL_SERVICE_USER=root
MYSQL_SERVICE_PASSWORD=123
MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&allowPublicKeyRetrieval=true&queryTimeout=2400&serverTimezone=Asia/Shanghai
```

简单介绍一下上面这些参数：

```properties
//直译：首选主机模式
PREFER_HOST_MODE=hostname
//使用模式单机模式
MODE=standalone
//直译过来是spring数据源平台（由于我们用的是mysql所以不用改）
SPRING_DATASOURCE_PLATFORM=mysql
//mysql链接参数
MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&allowPublicKeyRetrieval=true&queryTimeout=2400&serverTimezone=Asia/Shanghai
//mysql主机地址
MYSQL_SERVICE_HOST=172.17.0.2
//mysql数据库名
MYSQL_SERVICE_DB_NAME=nacos
//mysql端口
MYSQL_SERVICE_PORT=3306
//mysql用户名
MYSQL_SERVICE_USER=root
//mysql密码
MYSQL_SERVICE_PASSWORD=123
```

注意一下，这里mysql的主机地址需要在docker中查看一下：

```bash
docker inspect mysql

...
"Networks": {
                "doj": {
                    "IPAMConfig": null,
                    "Links": null,
                    "Aliases": null,
                    "MacAddress": "b2:d9:08:a4:5e:c4",
                    "DriverOpts": null,
                    "GwPriority": 0,
                    "NetworkID": "07a0ae8b7d9ec59fa8d4bc3f57817f0c4e6375d3ee18255a2575fe0ad88c9dda",
                    "EndpointID": "442fdbe8d9a318f44ae07f335012e54fd85ba2b23861c0b13c430ba734588dbb",
                    "Gateway": "172.18.0.1",
                    "IPAddress": "172.18.0.2",
                    "IPPrefixLen": 16,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
                    "DNSNames": [
                        "mysql",
                        "7dae50d05a92"
                    ]
                }
            }
...
```

就是上面的`IPAddress`

最后按照下面的命令运行，要注意设置`--network doj`

即确保nacos可以访问到mysql（放在docker中同一个网络下）

```bash
docker run -d \
    --name nacos \
    --env-file ./nacos/custom.env \
    -p 8848:8848 \
    -p 9848:9848 \
    -p 9849:9849 \
    --restart=always \
    --network doj\
    nacos/nacos-server:v2.5.1-slim
```

## Redis

为了支持长短令牌认证和分布式缓存，项目需要 Redis 服务。

1.  **创建本地目录和配置文件**

    ```sh
    # 创建用于挂载数据和配置的目录
    mkdir -p redis/data
    # 创建一个基础的配置文件
    touch redis/redis.conf
    ```
    在 `redis/redis.conf` 中可以添加自定义配置，例如 `bind 0.0.0.0`。

2.  **运行 Redis 容器**

    ```sh
    docker run -d \
      --name redis \
      -p 6379:6379 \
      -v ${PWD}/redis/data:/data \
      -v ${PWD}/redis/redis.conf:/usr/local/etc/redis/redis.conf \
      --network doj \
      redis:alpine redis-server /usr/local/etc/redis/redis.conf
    ```

    **命令解释**:
    *   `redis:alpine`: 使用基于 Alpine Linux 的轻量级 Redis 镜像。
    *   `-v ${PWD}/redis/data:/data`: 将主机当前目录下的 `redis/data` 文件夹挂载到容器内的 `/data` 目录，用于持久化存储 Redis 数据。
    *   `-v ${PWD}/redis/redis.conf:/usr/local/etc/redis/redis.conf`: 将我们本地的配置文件挂载到容器内对应的位置。
    *   `redis-server /usr/local/etc/redis/redis.conf`: 容器启动时，使用我们指定的配置文件来启动 Redis 服务。

---

## 配置写入

然后按照上面的配置修改每个微服务项目yaml配置文件

第一个：application.yaml

```yaml
server:
    port: ${doj.port.user-service}
doj:
    db:
        host: 127.0.0.1
        name: doj_user
        user: root
        pwd: 123
    swagger:
        title: 用户服务接口文档
        scan: com.decade.doj.user.controller
```

第二个：bootstrap.yaml

```yaml
spring:
    application:
        name: user-service
    profiles:
        active: dev, common
    cloud:
        nacos:
            server-addr: 127.0.0.1:8848
            config:
                file-extension: yaml
                shared-configs:
                    - dataId: shared-jdbc.yaml
                    - dataId: shared-swagger.yaml
                    - dataId: shared-jwt.yaml
```

有三个在nacos中共享的配置文件

![image-20250528192311959](http://upic-decade.oss-cn-shanghai.aliyuncs.com/uPic/2025_05_28_image-20250528192311959.png)

- shared-jdbc.yaml

```yaml
spring:
    datasource:
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://${doj.db.host:127.0.0.1}:3306/${doj.db.name}
        username: ${doj.db.user:root}
        password: ${doj.db.pwd:123}
  redis:
    host: ${doj.redis.host:localhost}
    port: 6379

mybatis-plus:
    global-config:
        db-config:
            update-strategy: not_null
            id-type: auto
```

- shared-swagger.yaml

```yaml
logging:
    level:
        com.decade: debug
    pattern:
        dateformat: HH:mm:ss:SSS
knife4j:
    enable: true
    openapi:
        title: ${doj.swagger.title}
        description: "Duck Online Judge API"
        email: "decade-qzj@foxmail.com"
        version: v1.0.0
        group:
            default:
                group-name: default
                api-rule: package
                api-rule-resources:
                    - ${doj.swagger.scan}
```

- shared-jwt.yaml

```yaml
doj:
    jwt:
        location: classpath:doj.jks
        alias: decade
        password: doj123
        tokenTTL: 30m
        refreshTokenTTL: 7d
        authorization: "authorization"
        secret-key: "uid"
```

