# D-OnlineJudge: 构建与开发指南

本文档为开发者提供一份清晰的指南，说明如何配置开发环境、构建和运行 D-OnlineJudge 项目的后端服务。

---

## 1. 环境准备 (Prerequisites)

在开始之前，请确保您的开发环境中已安装以下软件：

- **JDK**: 版本 `17` 或更高。请通过 `java --version` 命令确认。
- **Maven**: 版本 `3.6` 或更高，用于构建项目。请通过 `mvn --version` 确认。
- **Docker**: 用于运行 MySQL、Nacos 等依赖服务，以及作为代码沙箱的执行环境。
- **Docker Compose**: 用于编排和一键启动多个 Docker 容器。
- **Git**: 用于克隆项目代码。

---

## 2. 部署核心依赖服务

我们使用 Docker 和 Docker Compose 来快速部署项目所需的核心依赖：MySQL 和 Nacos。所有操作都在项目根目录 `/Users/qzj/Desktop/Development/D-OnlineJudge` 下进行。

### 2.1. 创建 Docker 网络

为了让所有容器能够方便地互相通信，首先创建一个专用的 Docker 网络。

```sh
docker network create doj
```

### 2.2. 部署 MySQL

1.  **创建本地目录**：用于持久化存储 MySQL 数据。

    ```sh
    mkdir -p mysql/{data,conf,init}
    ```

2.  **运行 MySQL 容器**：

    ```shdocker run -d \
      --name mysql \
      -p 3306:3306 \
      -e TZ=Asia/Shanghai \
      -e MYSQL_ROOT_PASSWORD=123 \
      -v ./mysql/data:/var/lib/mysql \
      -v ./mysql/conf:/etc/mysql/conf.d \
      -v ./mysql/init:/docker-entrypoint-initdb.d \
      --network doj \
      mysql:8.0.23
    ```

3.  **初始化数据库**：进入 MySQL 容器并创建项目所需的数据库。

    ```sh
    # 进入容器的 bash
    docker exec -it mysql bash

    # 登录 MySQL
    mysql -uroot -p123

    # 在 MySQL 命令行中执行以下 SQL
    CREATE DATABASE doj_user;
    CREATE DATABASE doj_problem;
    CREATE DATABASE doj_submission;
    CREATE DATABASE nacos;
    exit;

    # 退出容器
    exit;
    ```

    > **注意**: 更详细的表结构 `CREATE TABLE` 语句位于 `docs/SQL/` 目录和各个服务配置文档中，您可以在需要时手动导入。

### 2.3. 部署 Nacos

Nacos 依赖于 MySQL 存储其配置数据，因此需要先初始化 Nacos 的数据库表。

1.  **初始化 Nacos 数据库**：将 `docs/1.docker部署.md` 中提供的 Nacos SQL 初始化脚本导入到刚刚创建的 `nacos` 数据库中。

2.  **准备 Nacos 环境变量文件**：

    ```sh
    # 创建目录和文件
    mkdir -p nacos
    touch nacos/custom.env
    ```

3.  **获取 MySQL 容器 IP 地址**：Nacos 需要通过 IP 地址连接到 MySQL 容器。

    ```sh
    docker inspect mysql | grep IPAddress
    ```

    记下返回的 IP 地址（例如 `172.18.0.2`）。

4.  **编辑 `nacos/custom.env` 文件**，填入以下内容，并**将 `MYSQL_SERVICE_HOST` 的值替换为您上一步获取到的 IP 地址**。

    ```properties
    PREFER_HOST_MODE=hostname
    MODE=standalone
    SPRING_DATASOURCE_PLATFORM=mysql
    MYSQL_SERVICE_HOST=172.18.0.2 # <-- 替换成你的 MySQL 容器 IP
    MYSQL_SERVICE_DB_NAME=nacos
    MYSQL_SERVICE_PORT=3306
    MYSQL_SERVICE_USER=root
    MYSQL_SERVICE_PASSWORD=123
    MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&allowPublicKeyRetrieval=true&queryTimeout=2400&serverTimezone=Asia/Shanghai
    ```

5.  **运行 Nacos 容器**：

    ```sh
    docker run -d \
        --name nacos \
        --env-file ./nacos/custom.env \
        -p 8848:8848 \
        -p 9848:9848 \
        -p 9849:9849 \
        --restart=always \
        --network doj \
        nacos/nacos-server:v2.5.1-slim
    ```

### 2.4. 在 Nacos 中添加共享配置

1.  访问 Nacos 控制台：`http://localhost:8848/nacos` (默认用户名/密码: `nacos`/`nacos`)。
2.  进入 “配置管理” -> “配置列表”，点击右侧“+”号，创建以下三个共享配置文件。请确保 **Data ID** 和 **Group** 正确无误（通常使用默认的 `DEFAULT_GROUP`）。

    -   **Data ID**: `shared-jdbc.yaml`
    -   **内容** (请将 `${doj.db.host:127.0.0.1}` 中的 `127.0.0.1` 修改为您的宿主机 IP 或 Docker 网关 IP，以便微服务能访问到 MySQL):
        ```yaml
        spring:
            datasource:
                driver-class-name: com.mysql.cj.jdbc.Driver
                url: jdbc:mysql://${doj.db.host:127.0.0.1}:3306/${doj.db.name}
                username: ${doj.db.user:root}
                password: ${doj.db.pwd:123}
        mybatis-plus:
            global-config:
                db-config:
                    update-strategy: not_null
                    id-type: auto
        ```

    -   **Data ID**: `shared-swagger.yaml`
    -   **内容**:
        ```yaml
        logging:
            level:
                com.decade: debug
        knife4j:
            enable: true
            openapi:
                title: ${doj.swagger.title}
                description: "D-OnlineJudge API"
                version: v1.0.0
                group:
                    default:
                        group-name: default
                        api-rule: package
                        api-rule-resources:
                            - ${doj.swagger.scan}
        ```

    -   **Data ID**: `shared-jwt.yaml`
    -   **内容**:
        ```yaml
        doj:
            jwt:
                location: classpath:doj.jks
                alias: decade
                password: doj123
                tokenTTL: 30m
                authorization: "authorization"
                secret-key: "uid"
        ```

---

## 3. 构建和运行后端微服务

### 3.1. 生成 JWT 密钥库

`common` 模块需要一个 JKS 文件来签名和验证 JWT。在 `DOJ-BE/common/src/main/resources/` 目录下执行以下命令：

```sh
keytool -genkeypair -alias decade -keyalg RSA -keysize 2048 -validity 365 -keypass doj123 -keystore doj.jks -storepass doj123
```

### 3.2. 构建所有模块

在后端父项目 `DOJ-BE` 的根目录下，使用 Maven 进行编译和打包。

```sh
cd /Users/qzj/Desktop/Development/D-OnlineJudge/DOJ-BE
mvn clean install
```

### 3.3. 运行微服务

为每个微服务打开一个单独的终端，并从 `DOJ-BE` 根目录启动它们。建议按照以下顺序启动：

1.  **Gateway-Service**
    ```sh
    java -jar gateway-service/target/gateway-service-1.0-SNAPSHOT.jar
    ```
2.  **User-Service**
    ```sh
    java -jar user-service/target/user-service-1.0-SNAPSHOT.jar
    ```
3.  **Problem-Service**
    ```sh
    java -jar problem-service/target/problem-service-1.0-SNAPSHOT.jar
    ```
4.  **Submission-Service**
    ```sh
    java -jar submission-service/target/submission-service-1.0-SNAPSHOT.jar
    ```
5.  **Sandbox-Service**
    ```sh
    java -jar sandbox-service/target/sandbox-service-1.0-SNAPSHOT.jar
    ```

### 3.4. 验证服务状态

- **检查 Nacos**: 再次访问 Nacos 控制台 `http://localhost:8848/nacos`，进入 “服务管理” -> “服务列表”，您应该能看到所有已启动的微服务（`gateway-service`, `user-service` 等）都处于健康状态。
- **访问 API 文档**: 访问网关提供的聚合 API 文档 `http://localhost:8080/doc.html`，您应该能看到所有微服务的接口列表。

---

## 4. 代码沙箱 Docker 环境

`sandbox-service` 依赖于预先构建好的 Docker 镜像来执行代码。请确保您已经构建了项目所需的多语言执行环境镜像。

进入 `docs/7.Sandbox-service项目配置.md` 文件所在的目录，您会找到 `Dockerfile.cpp`, `Dockerfile.java`, `Dockerfile.python` 等文件。

使用以下命令构建镜像：

```sh
# 构建 C++ 环境镜像
docker build -t code-runner-cpp -f Dockerfile.cpp .

# 构建 Java 环境镜像
docker build -t code-runner-java -f Dockerfile.java .

# 构建 Python 环境镜像
docker build -t code-runner-python -f Dockerfile.python .
```

确保这些镜像在 `sandbox-service` 运行的 Docker 环境中是可用的。

