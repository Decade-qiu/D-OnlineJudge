### **项目：D-OnlineJudge 分布式在线判题系统**

### **第一部分：需求规格说明书 (Requirements Specification Document)**

#### **1. 项目概述**

D-OnlineJudge 是一个基于 Java Spring Cloud 微服务架构和 Vue 3 前端构建的全栈在线编程和判题平台。项目旨在为编程学习者、竞赛参与者和教育工作者提供一个稳定、安全、功能丰富的在线编程环境。

**核心价值**:

*   **微服务架构**: 系统采用模块化设计，各服务职责单一、可独立部署和扩展，保证了系统的高内聚和低耦合。
*   **安全沙箱**: 通过 Docker 容器化技术，为用户代码提供一个资源隔离、安全的执行环境，有效防止恶意代码攻击。
*   **前后端分离**: 现代化的前后端分离架构，使得前端（UI/UX）和后端（业务逻辑）可以并行开发、独立演进。
*   **统一的开发体验**: 提供完整的文档和部署指南，支持通过 Docker Compose 一键启动整个后端环境，简化了开发和部署流程。

#### **2. 功能性需求 (Functional Requirements)**

**2.1. 用户模块 (`user-service`)**

*   **FR-1**: 支持用户通过邮箱和密码进行注册和登录。
*   **FR-2**: 支持用户查看和编辑个人资料（如用户名、头像、学校、个性签名等）。
*   **FR-3**: 支持用户密码的加密存储和安全修改。
*   **FR-4**: 系统应包含角色管理，至少分为普通用户和管理员两种角色。

**2.2. 题目模块 (`problem-service`)**

*   **FR-5**: 管理员能够创建、编辑、查看和删除编程题目。
*   **FR-6**: 题目应包含丰富的元数据，如：题面描述、输入/输出格式、样例、时间限制、内存限制、难度、标签等。
*   **FR-7**: 普通用户能够按列表或ID查看题目详情。
*   **FR-8**: 支持根据题号、难度、标签等条件对题目进行筛选和搜索。

**2.3. 提交与判题模块 (`submission-service` & `sandbox-service`)**

*   **FR-9**: 用户能够针对特定题目，选择编程语言（如 C++, Java, Python）并提交代码。
*   **FR-10**: 系统必须记录每一次提交，包括提交人、题目、代码、提交时间、语言等。
*   **FR-11**: 代码必须在安全隔离的沙箱环境中执行。
*   **FR-12**: 沙箱必须对代码的**运行时间**和**内存使用**进行严格限制，并能处理超时（Time Limit Exceeded）和超内存（Memory Limit Exceeded）等情况。
*   **FR-13**: 系统能够自动将用户代码的输出与预设的标准答案进行比对，并返回判题结果，至少包括：
    *   Accepted (AC)
    *   Wrong Answer (WA)
    *   Compile Error (CE)
    *   Time Limit Exceeded (TLE)
    *   Memory Limit Exceeded (MLE)
    *   Runtime Error (RE)
*   **FR-14**: 用户可以查看自己的提交历史、状态和详细的判题结果。

**2.4. 网关与认证模块 (`gateway-service`)**

*   **FR-15**: 所有对后端微服务的请求都必须通过 API 网关进行路由。
*   **FR-16**: 网关必须对除白名单（如登录、注册）外的所有请求进行 JWT 身份认证。
*   **FR-17**: 网关需要处理跨域请求，以支持前后端分离部署。

#### **3. 非功能性需求 (Non-Functional Requirements)**

*   **NFR-1 (安全性)**:
    *   用户密码等敏感信息必须加密存储。
    *   必须通过 Docker 沙箱有效防止用户提交的恶意代码对服务器造成破坏。
    *   API 接口需进行有效的认证和授权。
*   **NFR-2 (可靠性)**:
    *   核心业务服务应设计为无状态，支持多实例部署以实现高可用。
    *   使用 Nacos 作为服务注册中心，确保服务的动态发现和故障转移。
*   **NFR-3 (可扩展性)**:
    *   微服务架构允许各个模块（用户、题目、提交）独立进行水平扩展。
    *   代码沙箱应易于扩展，以支持更多的编程语言。
*   **NFR-4 (可维护性)**:
    *   提供详细的 API 文档（通过 Knife4j/Swagger）。
    *   提供基于 Docker 的一键部署方案，简化开发和运维流程。
    *   代码结构清晰，遵循 Spring Boot 社区的最佳实践。

-----

### **第二部分：项目计划与里程碑 (Development Plan)**

**里程碑 1: 核心架构与基础服务搭建 (MVP) - ✅ 已完成**

*   **目标**: 验证微服务架构的可行性，搭建核心基础服务。
*   **核心交付物**:
    *   **项目结构**: 搭建了基于 Maven 的多模块项目 `DOJ-BE`，包含 `user-service`, `problem-service`, `submission-service`, `gateway-service`, `sandbox-service`, 和 `common` 模块。
    *   **服务治理**: 集成 Nacos 作为服务注册中心和统一配置中心。
    *   **API 网关**: `gateway-service` 搭建完成，实现了基本的路由功能。
    *   **用户服务**: `user-service` 完成，提供用户注册和登录的基础功能。
    *   **题目服务**: `problem-service` 完成，支持题目的增删改查。

**里程碑 2: 认证与安全沙箱实现 (Alpha) - ✅ 已完成**

*   **目标**: 打通认证流程，并实现核心的、安全的代码判题功能。
*   **核心交付物**:
    *   **统一认证**: `gateway-service` 集成 JWT，实现了全局的、无状态的身份认证和鉴权。
    *   **服务间通信**: 微服务之间通过 OpenFeign 进行调用，并实现了调用链路中的用户身份传递。
    *   **Docker 沙箱**: `sandbox-service` 搭建完成，能够接收代码和语言，启动隔离的 Docker 容器执行代码，并对时间和内存进行限制。
    *   **异步判题**: `sandbox-service` 采用异步线程池处理判题任务，提高了系统的响应能力和吞吐量。
    *   **提交服务**: `submission-service` 能够接收提交请求，调用沙箱服务，并记录判题结果。

**里程碑 3: 业务功能完善与部署 (Beta) - ✅ 已完成**

*   **目标**: 完善核心业务流程，并提供完整的部署和文档支持。
*   **核心交付物**:
    *   **数据库设计**: 完成了 `user`, `problem`, `submission` 三个核心业务的数据库表结构设计和初始化。
    *   **API 文档**: 所有微服务均集成了 Knife4j，提供清晰、可交互的 API 文档。
    *   **Docker Compose 部署**: 提供了完整的 `docker-compose` 部署方案，能够一键启动 MySQL, Nacos 以及所有后端微服务，极大地简化了开发和测试环境的搭建。
    *   **详细文档**: 编写了包括 Docker 部署、各服务配置、远程调用在内的多份详细开发文档。

-----

### **第三部分：后端项目结构 (Backend Project Structure)**

后端项目 `DOJ-BE` 遵循标准的 Maven 多模块项目布局。

```
DOJ-BE/
├── pom.xml               # 父项目 POM，管理所有依赖和模块
├── common/                 # 公共模块 (工具、配置、Feign 客户端)
│   ├── pom.xml
│   └── src/
├── gateway-service/        # API 网关服务
│   ├── pom.xml
│   └── src/
├── user-service/           # 用户服务
│   ├── pom.xml
│   └── src/
├── problem-service/        # 题目服务
│   ├── pom.xml
│   └── src/
├── submission-service/     # 提交服务
│   ├── pom.xml
│   └── src/
└── sandbox-service/        # 代码沙箱服务
    ├── pom.xml
    └── src/
```

**结构说明**:

*   **`DOJ-BE/pom.xml`**: 这是父项目的 `pom.xml`，它通过 `<packaging>pom</packaging>` 定义自己为聚合项目。它在 `<modules>` 部分列出了所有子模块，并在 `<dependencyManagement>` 中统一管理了整个项目的依赖版本（如 Spring Boot, Spring Cloud, MyBatis-Plus 等），确保了版本的一致性。
*   **`common/`**: 这是一个公共工具模块，被所有其他业务微服务依赖。它通常包含：
    *   **工具类**: 如 `JwtTool`, `AesTool` 等。
    *   **配置类**: 全局生效的配置，如 `MybatisConfig`, `MVCConfig`，以及通过 `spring.factories` 自动装配的全局异常处理器。
    *   **Feign 客户端**: 定义了所有跨服务调用的 Feign 接口（如 `UserClient`）。
    *   **共享模型**: 如 DTOs, VOs, 和通用的响应结果类 `R`。
*   **`gateway-service/`**: Spring Cloud Gateway 应用，负责路由和过滤。
*   **`user-service/`, `problem-service/`, `submission-service/`**: 标准的 Spring Boot 应用，分别对应一个核心业务领域。每个服务都有自己的 `Controller`, `Service`, `Mapper` 和 `Entity` 层。
    **`sandbox-service/`**: 核心的判题服务，同样是一个 Spring Boot 应用，但其内部逻辑更侧重于与 Docker 引擎的交互和异步任务处理。

---

## 第四部分：架构升级与演进计划

为实现一个更健壮、可扩展的系统，我们制定了清晰的演进计划。

- **[ ] 中间件集成**
    - [x] **集成 Redis**: 用于实现长短令牌存储、分布式缓存和高性能任务队列。
    - [x] **集成 Message Queue (RabbitMQ)**: 用于实现服务间的事件驱动和异步解耦。
    - [x] **集成 Sentinel**: 在网关层实现流量控制与熔断降级。

- **[ ] 实时通信**
    - [x] **实现 WebSocket 服务**: 用于向前端实时推送判题结果。

- **[ ] 可观测性建设**
    - [x] **集成 SkyWalking**: 搭建分布式链路追踪系统。
    - [x] **部署 Prometheus & Grafana**: 建立统一的指标监控与告警平台。
    - [x] **部署 ELK 或 Loki**: 建立集中式的日志管理系统。

- **[ ] 自动化运维**
    - [x] **建立 CI/CD 流水线**: 使用 Jenkins 或 GitHub Actions 自动化项目的测试、构建和部署流程。
