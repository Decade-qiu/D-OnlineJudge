name: CI/CD for DOJ Backend

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ['user-service', 'problem-service', 'submission-service', 'sandbox-service', 'gateway-service']

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          SERVICE_NAME=${{ matrix.service }}
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/doj-${SERVICE_NAME}
          # Build the Docker image using the project root as context
          docker build -t ${IMAGE_NAME}:latest -f DOJ-BE/${SERVICE_NAME}/Dockerfile .
          # Push the Docker image
          docker push ${IMAGE_NAME}:latest

  # deploy:
  #   needs: build-and-push
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Deploy to server
  #       uses: appleboy/ssh-action@master
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USERNAME }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         script: |
  #           cd /path/to/your/project/D-OnlineJudge
  #           git pull
  #           docker-compose pull
  #           docker-compose up -d --force-recreate
